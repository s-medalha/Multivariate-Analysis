---
title: Perspectives on Immigration, Gender Equality and Trust in Public Institutions in Europe
author:
  - Ana Rasinhas (20241393)
  - Daniela Gonçalves (20251421)
  - Pedro Fernandes (20251418)
  - Ricardo Branco (20251164)
  - Samuel Medalha (20250080)
abstract: |
  {{< lipsum 1 >}}
date: last-modified
date-format: long
format:
  pdf:
  #academic-typst:
    #section-numbering: "1.1.1"
    document-class: article
    number-sections: true
    toc: true
execute:
  echo: false
  warning: false
---

```{r}
#| label: load-packages
#| include: false

library(tidyverse)
library(readxl)
library(psych)
library(cluster)
library(factoextra)
library(dendextend)
library(ggrepel)
library(tinytable)
library(FactoMineR)
library(reshape2)
```

```{r}
#| label: import-data
#| include: false
#| warnings: false
#| cache: true

raw_data <- read_excel("./dataset2.xlsx", range = cell_cols("A:YT"), sheet = 1)

```

```{r}
#| label: data-processing
#| include: false
#| warnings: false

selected_vars <- c("cntry", "trstprl", "trstlgl", "trstplt", "trstprt", "trstep", "trstun", "stfeco", "stfgov", "stfdem", "stfedu", "stfhlth", "imbgeco", "imueclt", "imwbcnt", "imsmetn", "imdfetn", "impcntr", "eqwrkbg", "eqpolbg", "eqmgmbg", "eqpaybg", "eqparep", "eqparlv", "freinsw", "fineqpy")

#selected_vars1 <- c("trstprl", "trstlgl", "trstplc", "trstplt", "trstprt", "trstep", "trstun", "stfeco", "stfgov", "stfdem", "stfedu", "stfhlth", "imbgeco", "imueclt", "imwbcnt")

reduced_scale_vars <- c("imsmetn", "imdfetn", "impcntr", "eqwrkbg", "eqpolbg", "eqmgmbg", "eqmgmbg", "eqpaybg", "eqparep", "eqparlv", "freinsw", "fineqpy")

inverted_vars <- c("imsmetn", "imdfetn", "impcntr", "eqparep", "eqparlv", "freinsw", "fineqpy")

removed_vars <- c("stfeco", "stfgov", "stfdem", "stfedu", "stfhlth", "eqparep", "eqparlv", "freinsw", "fineqpy")

removed_countries <- c("IS", "IL", "ME", "NO", "RS", "CH", "UA", "GB")

data <- raw_data |> 
  select(all_of(selected_vars)) |> # select only some variables
  filter(!cntry %in% removed_countries) |>  # remove non-EU countries
  mutate(across(all_of(selected_vars), ~if_else(. %in% c(77, 88, 99), NA, .))) |> # set to NA when answer is unknown
  mutate(across(all_of(reduced_scale_vars), ~if_else(. %in% c(7,8,9), NA, .))) |> # set to NA when answer is unknown
  na.omit() |> # omit missing values
  mutate(imsmetn = 5 - imsmetn, 
         imdfetn = 5 - imdfetn,
         impcntr = 5 - impcntr) |> # invert scale of some variables
  select(-all_of(removed_vars))

scaled_data <- data |> 
  select(-cntry) |> 
  scale() |> 
  as_tibble()

```

## Introduction

Ever since its creation, the European Union has shown a commitment to record and gather the relevant data about the how Europeans think about their present and expect for the future.

In this paper, we focus on the European Social Survey (ESS), particularly the ESS round 11. The ESS is an academically driven, cross-national survey founded in 2001. Conducted in 40 different counties, this survey measures the attitudes, beliefs and behaviour patterns of diverse populations. Additionally, it requires strict random probability sampling, seeks a high response rate and uses rigorous translation protocols. It aims at operating a research infrastructure that provides high quality data, within and between European countries in their living conditions, social structure, public opinion and attitudes; practicing and encouraging the highest scientific standards in cross-national comparative research in the social sciences; and safeguarding the visibility, accessibility and reach of ESS data among researchers in the social sciences and beyond, policy makers and the wider public, at both the national and international levels[^1].

[^1]: European Social Survey European Research Infrastructure (ESS ERIC) (2025) ESS round 11 - 2023. Social inequalities in health, Gender in contemporary Europe. Sikt - Norwegian Agency for Shared Services in Education and Research. <https://doi.org/10.21338/ess11-2023>

Given the extensive nature of the survey, we choose to focus on topics that have been extensively discussed in Europe the past decade: immigration, gender equality and trust in public institutions.

One of the core objectives of the European Union was to constitute an area of freedom, security and justice. To achieve this, the EU has developed common measures framing a policy on asylum and immigration, based on solidarity between Member States, which is fair towards third countries and their nationals[^2].

[^2]: Perceptions, & Perceptions. (2022, November 14). Current migration trends in and within Europe. PERCEPTIONS. <https://www.perceptions.eu/current-migration-trends-in-and-within-europe-2/>

In 2014, the European Commission and Directorate-General for Migration and Home Affairs created of the Asylum, Migration and Integration Fund (AMIF) in 2014. It was set up with a budget of 3,76 billion euros for 2014–2020. For the period of 2021-2027, the budget increased to 10,94 billion euros.\
Its goals are to contribute to the strengthening and developing the Common European Asylum System (CEAS), support legal migration to EU Member States in line with the labour market needs and the effective integration of non-EU nationals; enhancing fair and effective return strategies, which contribute to combating irregular migration, with an emphasis on sustainability and effectiveness of the return process; and making sure that EU Member States which are most affected by migration and asylum flows can count on solidarity from other EU Member States, while fully respecting the rights and principles enshrined in the Charter of Fundamental Rights of the European Union[^3] [^4].

[^3]: Asylum, Migration and Integration Fund (2021-2027). (n.d.). Migration and Home Affairs. <https://home-affairs.ec.europa.eu/funding/asylum-migration-and-integration-funds/asylum-migration-and-integration-fund-2021-2027_en>

[^4]: L_2014150EN.01016801.XML. (n.d.). <https://eur-lex.europa.eu/legal-content/EN/TXT/HTML/?uri=CELEX:32014R0516>

According to the Internation Organization for Migration (IOM), the reception of irregular migrants and refugees in Europe peaked in 2015. It has since been steadily decreasing until reaching around 144 thousand people until the 1st of December of 2025. This flow of people, which was punctuated by thousands of deaths, forced the EU to heavily discuss migration policies. The European Parliament considers immigration one of the key concerns of European citizens and expects it to remain a challenge for years to come[^5].

[^5]: Europe Arrivals \| Displacement Tracking Matrix. (n.d.). IOM UN Migration. Retrieved December 8, 2025, from <https://dtm.iom.int/europe/arrivals?type=arrivals>

On of the common values of the European Union, protected under the Lisbon Treaty, is the equality of men and women. Pushing for gender equality is one of the Union's tasks (Article 3), as per the terms of the Treaty on the European Union. Additionally, it is also inscribed in articles 8 and 19 of the Treaty on the Functioning of the European Union, which instructs the Union to, in all its actions, ensure the respect of equality between men and women, and in article 23 of the Charter of Fundamental Rights, particularly in terms of wages and work[^6] [^7].

[^6]: Women’s rights and gender equality in the European Union. (n.d.). <https://www.bmfwf.gv.at/en/women-and-equality/women-s-rights-and-gender-equality-in-the-eu.html>

[^7]: EU Funding & Tenders Portal. (n.d.). <https://ec.europa.eu/info/funding-tenders/opportunities/portal/screen/programmes/cerv>

In 2017, the European Commission commissioned a report on the gender equality and gender pay gap where it was concluded that gender equality is very important to Europeans. Some of the most relevant results point that most European believe in the promotion of gender equality to the ensure a fair and democratic society and in the importance of gender equality for companies, the economy and for them personally[^8].

[^8]: European Commission. (n.d.). Eurobarometer. <https://europa.eu/eurobarometer/surveys/detail/2154>

The European Parliament has been approving several resolutions on this issue. Nevertheless, in the latest report on gender equality ordered by the European Commission, it was found that, as the EU’s 2020–2025 gender equality strategy concludes, progress remains uneven and fragile: women’s representation in the European Parliament has declined for the first time, and global setbacks underscore persistent threats to women’s rights.

Women remain under-represented in decision-making and disproportionately responsible for care work. The Gender Equality Index shows gradual EU-wide improvement but wide disparities between Member States, while ongoing resistance to women’s rights in parts of and beyond the EU reinforces the need for continued vigilance. Hence, the Commission plans a new roadmap to guide long-term efforts toward full equality in the coming five years[^9].

[^9]: European Commission: Directorate-General for Justice and Consumers, 2025 report on gender equality in the EU, Publications Office of the European Union, 2025, <https://data.europa.eu/doi/10.2838/5262357>

Finally, in recent years, the research on the role of institutions for economic growth has shown the significance that the quality and reliability of formal institutions have in fostering economic development and growth, as well as fostering political trust among citizens.

In fact, political trust has been associated with the significant development in regional economic development. Political trust can impact regional economic development in two ways: on one hand, it validates the government and foster the acceptance of its measures, resulting in increased adherence to the law, better economic strategies, and strengthened third-party enforcement; and, on the other hand, political trust encourages traditional political involvement, which subsequently nurtures additional types of collaborative actions[^10].

[^10]: Muringani, J., Fitjar, R.D. & Rodríguez-Pose, A. Political trust and economic development in European regions. Ann Reg Sci 73, 2059–2089 (2024). <https://doi.org/10.1007/s00168-024-01319-5>

The last 5 years have been troublesome for Europe. After enduring the COVID-19 pandemic, the war in Ukraine and following cost-of-living crisis, the trust in trust in the EU and the national institutions suffered a deep erosion.\
The Eurofund has found that the trust in the EU has increased since the onset of the pandemic (although, remaining at a low levels), and that that trust in national governments has decreased. It has also found that the levels of trust are unevenly distributed and decreased unevenly among socio-demographic groups, posing the risk of social fragmentation.\
The main drivers to this decline in confidence involve a combination of economic and social elements, such as the cost-of-living crisis, feeling disregarded, and the polarizing influence of alternative media platforms like social media, which serves to exploit and amplify discontent. All these elements contribute to an increasing divide between the citizens and their governments[^11].

[^11]: Trust in crisis: Europe’s social contract under threat \| Eurofound. (n.d.) <https://www.eurofound.europa.eu/en/commentary-and-analysis/all-content/trust-crisis-europes-social-contract-under-threat>

Therefore, using the questions of ESS 11, we aim at the following:

-   Q1: Identify the common factors that impact Europeans views of immigration, gender equality and trust in the political players, using Factor Analysis;

-   Q2: Describe the profile of the EU countries regarding these matters, working with Cluster Analysis;

-   Q3: Analyze the association between the levels of trust in public entities and the satisfaction with democracy of Portuguese citizens in different gender groups.

## Methodology

### Variable Selection

The data used is from the European Social Survey (ESS), more specifically the Round 11 data (2023/24), Edition 4.0. The 11th ESS round covers 30 countries, where data was collected based on an hour-long face-to-face interview, covering a variety of core topics repeated from previous rounds of the survey and two modules developed for Round 11: “Gender in Contemporary Europe: Rethinking Equality and the Backlash” and “Social Inequalities in Health and their Determinants”. The universe considered consists of individuals aged from 15 and over, resident within private households, regardless of their nationality, citizenship, language or legal status, in the 30 considered countries.

From the full dataset, only variables relevant to the conceptual domains of institutional trust, attitudes toward immigration, and beliefs about social and gender equality were retained, comprising 16 variables. The selected variables and associated questions can be seen in @tbl-vars in the Appendix.

Due to the different Likert-type scales, all analytical variables were standardized. Without standardization, variables with larger numerical ranges would dominate factor extraction and clustering. Standardization ensures that each variable contributes equally to the underlying covariance structure.

The mentioned version of the survey collected individual-level citizen responses across 30 countries, resulting in 50.116 observations. To limit the study to European Union (EU) member states, respondents from non-EU countries were removed from the dataset, resulting in a final sample covering 22 countries.

The ESS uses several numeric codes to represent non-substantive responses, such as “Refusal” (codes 77 or 7), “Don’t know” (codes 88 or 8), and “No answer” (codes 99 or 9). All these incomplete observations were removed from the analysis, to ensure that the analytical dataset contained only complete cases, which is a requirement for the factor analysis procedures used in this study. At the end, this process led to 28.303 observations.

Because ESS sample sizes vary across countries due to their national sampling designs, we chose to retain the original number of observations per country to preserve the importance and weight attributed to each country in the survey. The sample size of each country can be seen in @tbl-obs in the Appendix.

All data preparation, factor analyses, and clustering procedures were performed in R, using standard packages for multivariate analysis.

### Factor Analysis

Factor Analysis (FA) was chosen over Principal Component Analysis (PCA) because the goal was to identify underlying concepts, such as institutional trust, attitudes toward immigration, and beliefs about gender equality, and not simply data reduction. FA is specifically designed to model these intangible factors that explain the correlations among the observed survey items, which aligns directly with the theoretical nature of the concepts being studied.

```{r}
#| label: KMO
#| warning: false
#| include: false
KMO(scaled_data)
```

After executing the Kaiser-Meyer-Olkin test, the MSA (measure of sampling accuracy, which varies between 0 and 1) is calculated as `r format(KMO(scaled_data)$MSA, digits = 2)`. This measure is an indicator of homogeneity between variables, that serves to indicate how appropriate the date is for Factor Analysis. The literature suggests that KMO values should be above 0.60 to be considered tolerable for Factor Analysis, although ideally it should be as close to 1 as possible.

```{r}
#| label: fig-corr-matrix
#| fig-cap: "Correlation Heatmap"
cormat <- round(cor(scaled_data), 2)


# Get lower triangle of the correlation matrix
  get_lower_tri<-function(cormat){
    cormat[upper.tri(cormat)] <- NA
    return(cormat)
  }
# Get upper triangle of the correlation matrix
  get_upper_tri <- function(cormat){
    cormat[lower.tri(cormat)]<- NA
    return(cormat)
  }
  
upper_tri <- get_upper_tri(cormat)
  
melted_cormat <- melt(upper_tri, na.rm = TRUE)

ggplot(data = melted_cormat, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Correlation") +
  theme_minimal()+ 
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 12, hjust = 1))+
  theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank(),
  axis.ticks = element_blank(),
  legend.justification = c(1, 0),
  legend.position = c(0.6, 0.7),
  legend.direction = "horizontal")+
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                title.position = "top", title.hjust = 0.5)) +
 coord_fixed()
```

The correlation matrix shows that each variable has, at least, one absolute correlation coefficient of 0.5 with another variable.\
Therefore, we can conclude that correlations among variables were sufficiently strong to warrant factor extraction.

```{r}
#| label: first_fa
#| warning: false
#| include: false
round(principal(scaled_data, nfactors = length(scaled_data))$Vaccounted, digits = 3)
round(fa(scaled_data, nfactors = length(scaled_data))$Vaccounted, digits = 3)
```

#### Number of Factors

To select the number of factors to retain, Kaiser’s criterion, Scree plot and Pearson’s criterion were analyzed. According to Kaiser’s rule, only three factors have eigenvalues greater than 1, suggesting a three-factor solution. The scree plot shows a marked elbow at the fourth component, also suggesting a three-factor solution (4 minus 1).

Although Pearson’s criterion recommends retaining factors that together explain at least 80% of the total variance, our data does not meet this threshold, with the three retained components accounting for approximately 68% of the variance (as demonstrated in @tbl-Vaccounted below). Nonetheless, a three-factor structure was ultimately chosen because it is supported by Kaiser’s criterion and Scree plot, and it offered the most coherent and theoretically meaningful interpretation of the data.

```{r}
#| label: fig-scree-plot
#| fig-cap: Scree plot
scree(scaled_data, factors = FALSE, main = "")
```

#### Rotation

Factor extraction was repeated using both Principal Component Analysis (PCA) and Principal Axis Factoring (PAF) combined with Varimax and Quartimax rotations. Orthogonal rotations were chosen to produce factors that are uncorrelated and easier to interpret. Loadings were examined to determine the variables most strongly associated with each factor. Although no substantive interpretations are presented in this section, these factors form the basis for the construction of factor scores.

PCA with *Varimax* rotation showed the most interpretable and stable factor structure, as well as better loadings and cumulative variance. This solution produced clearly defined factors with high loadings on conceptually coherent variables, facilitating theoretical interpretation. Other factors structures were tested and are presented in Annex XX.

```{r}
#| label: tbl-varimax-results
#| tbl-cap: "PCF Varimax Loadings"
library(gt)

pcf_varimax <- principal(scaled_data, nfactors = 3, method = "cov", rotate = "varimax", scores = TRUE)
pcf_quartimax <- principal(scaled_data, nfactors = 3, method = "cov", rotate = "quartimax")
paf_varimax <- fa(scaled_data, nfactors = 3, rotate = "varimax")
paf_quartimax <- fa(scaled_data, nfactors = 3, rotate = "quartimax")

# Convert to data frame
loadings_df <- as.data.frame.matrix(pcf_varimax$loadings[])
loadings_df <- round(loadings_df, 3)

# Create gt table with conditional formatting
gt(loadings_df, rownames_to_stub = TRUE) |>
  sub_missing(missing_text = "") |>
  data_color(
    columns = everything(),
    fn = function(x) {
      case_when(
        abs(as.numeric(x)) >= 0.7 ~ "darkgreen",
        abs(as.numeric(x)) >= 0.6 ~ "green",
        TRUE ~ "white"
      )
    }
  )
```

```{r}
#| label: tbl-Vaccounted
#| tbl-cap: Cumulative Variance
gt(as.data.frame(round(pcf_varimax$Vaccounted["Cumulative Var", , drop = FALSE], 3)))
```

### Cluster Analysis

After the use of Factor Analysis – in which we found three latent dimensions – we used Cluster Analysis to aggregate factor scores by country. For each country, the mean value of each factor's score was calculated. The resulting country-level dataset consists of three standardized latent dimensions representing national averages of institutional trust, immigration attitudes, and gender equality perspective. Before clustering, these countries' means were standardized to equalize their contribution to distance calculations. Since there is no substantive reason to preserve differences in variance across the three factors (the variances of the three factors are similar), standardization ensures that no factor disproportionately influences the resulting clusters.

#### Hierarchical Cluster Analysis

To classify countries based on their average, a hierarchical cluster analysis was performed. Distances between countries were computed using Euclidean distance, and multiple linkage methods (Ward’s method, Average linkage, Centroid, Complete linkage, and Single linkage) were compared to evaluate the stability and structure of the resulting clusters. The Ward’s method was chosen, because it minimizes within-cluster variance and it produces more interpretable and compact groupings, which allows for better characterization of countries according to their broader attitudinal profiles rather than detect minimal chaining or highly irregular clusters.

```{r}
#| label: country-means
data_scores2 <- cbind(data["cntry"], pcf_varimax$scores)

country_means2 <- data_scores2  %>% 
  group_by(cntry)  %>% 
  summarise(across(starts_with("RC"), mean))  %>%  
  rename("country" = cntry, "trust" = RC2, "immigration" = RC1, "equality" = RC3)

#new features like country labels and sample size
# country_means2$country <- rownames(country_means2)
# 
# sample_size <- data %>%
#   count(cntry, name = "n") %>% 
#   rename(country = cntry)
# 
# country_means2 <- country_means2 %>%
#   left_join(sample_size, by = "country")

```

```{r}
#| label: R-squared-function
#| include: false

numeric_data <- country_means2[ , -1, drop = FALSE]

numeric_data <- scale(numeric_data)

RSquared <- function(distance, method, k){
  # Get vector with mean of each variable
  centroid <- colMeans(numeric_data)
  # Get total SS
  SSt <- sum(apply(numeric_data, 1, function(row) sum((row - centroid)^2)))
  # Get distance matrix
  dist_matrix <- dist(numeric_data, method = distance)
  # Hierarchical clustering
  hc <- hclust(dist_matrix, method = method)
  # Cut dendrogram with k clusters
  cut <- cutree(hc, k = k)
  SSw <- 0
  for(i in 1:k) {
    # Get indices of countries in cluster i
    cluster_indices <- which(cut == i)
    
    if(length(cluster_indices) > 0) {
      # Get data for this cluster
      cluster_data <- numeric_data[cluster_indices, , drop = FALSE]
      
      # Calculate cluster mean
      cluster_mean <- colMeans(cluster_data)
      
      # Weighted squared distance from cluster centroid
      SSw <- SSw + sum(apply(cluster_data, 1, function(row) 
      sum((row - cluster_mean)^2)))
    }
  }
  1-(SSw/SSt)
}

```

```{r}
#| label: fig-R-squared-plot
#| fig-cap: "R-squared values of the different hierarchical methods"

methods <- c("ward.D", "average", "complete", "single", "centroid")

plot_data <- do.call(rbind, lapply(methods, function(method) {
  data.frame(
    k = 1:10,
    R_squared = sapply(1:10, function(k) {
      RSquared("euclidean", method, k)
    }),
    Method = method
  )
}))

  ggplot(plot_data, aes(x = k, y = R_squared, color = Method)) +
    geom_line(size = 0.5) +
    geom_point(size = 1) +
    coord_cartesian(ylim = c(0, 1)) +
    scale_x_continuous(breaks = 1:10) +
    scale_y_continuous(breaks = (0:10)/10) +
    labs(x = "Number of clusters", y = "R-squared")
```

Several possible cut-points were examined, and a five-cluster solution was chosen, as the R² values increased substantially up to five clusters before leveling off. The R2 with 5 clusters is 0.753, which is a significant improvement from the 4-cluster solution (R2 = 0.654 with 4 clusters), while the jump from 5 to 6 clusters does not lead to a great improvement in the R2 (R2 = 0.804 with 6 clusters).

Additionally, the analysis of the Ward dendrogram in @fig-dendrogram leads to the same conclusion, as the cut should be done in the largest vertical distance without any horizontal mergers.

Therefore, this solution demonstrated strong coherence, stability of the grouping across alternative linkage methods, and it was supported by the cluster dendrogram, while being interpretable.

```{r}
#| label: fig-dendrogram
#| fig-cap: "Dendrogram - Ward Method"
# 1. Prepare data (select only numeric variables for clustering)
cluster_data <- country_means2[, c("trust", "immigration", "equality")]
rownames(cluster_data) <- country_means2$country

# 2. Hierarchical methods to determine number of clusters

# Ward method
hc_ward <- agnes(cluster_data, metric = "euclidean", method = "ward")

# Average method
hc_average <- agnes(cluster_data, metric = "euclidean", method = "average")

# Complete method
hc_complete <- agnes(cluster_data, metric = "euclidean", method = "complete")

# Single method
hc_single <- agnes(cluster_data, metric = "euclidean", method = "single")


fviz_dend(hc_ward, k = 5, sub = "", palette = "npg")
#rect.hclust(hc_ward, k = 5, border = "red")

# pltree(hc_ward, main = "Dendrogram - Ward Method", hang = -1, cex = 0.8)
# rect.hclust(hc_ward, k = 4, border = "red")
# 
# fviz_nbclust(cluster_data, kmeans, method = "wss")
# 
# fviz_nbclust(cluster_data, kmeans, method = "silhouette")
```

```{r}
my_theme <- function(base_size = 12) {
  theme_minimal(base_size = base_size) +
    theme(
      # Customizing the title and subtitle
      plot.title = element_text(face = "bold", size = 14, margin = margin(b = 10)),
      plot.subtitle = element_text(size = 11, color = "gray30", margin = margin(b = 15)),
      # Grid line cleanup
      panel.grid.minor = element_blank(),
      panel.grid.major = element_line(linetype = "dotted", color = "gray85"),
      # Axis line customization
      axis.line = element_line(color = "gray80"),
      # Legend position
      legend.position = "bottom",
      # Caption formatting
      plot.caption = element_text(hjust = 0, color = "gray50", size = 9, margin = margin(t = 15)),
      # Panel background and spacing
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA)
    )
}

```

```{r}
#Random k-means
set.seed(123) #for replicability

kmeans_result <- kmeans(cluster_data, centers = 5, nstart = 25, iter.max = 100) # nstart = different initial positions; 

# print(kmeans_result)

country_clusters <- country_means2
country_clusters$cluster <- as.factor(kmeans_result$cluster)

```

```{r}
#deterministic k-means using hierarchical method
hcward <- agnes(cluster_data, method = "ward")

groups_hcward <- cutree(as.hclust(hcward), k = 5) #cut the tree into 5 clusters (k)

initial_centers <- aggregate(cluster_data, by = list(groups_hcward), FUN = mean) #compute deterministic initial centroids

initial_centers <- initial_centers[ ,-1] # remove group label column

#compute k-means
kmeans_result_d <- kmeans(cluster_data, centers = initial_centers, iter.max = 100)

#merge to data
country_clusters_d <- country_means2
country_clusters_d$cluster <- as.factor(kmeans_result_d$cluster)

# print(kmeans_result_d$centers)
# print(table(country_clusters_d$cluster))
```

#### Non-hierarchical Cluster Analysis

To refine and validate the results obtained from the hierarchical analysis, a non-hierarchical method (k-means) was applied. Unlike hierarchical approaches, k-means requires specifying the number of clusters (k) beforehand and iteratively update assignments until finding the best approach.

The number of clusters was set to k = 5, in line with the hierarchical results. Two initialization strategies were used to build a comparison and benchmark with the previous approach:

1.  Random centroids: Initial cluster centroids were randomly selected, and each country was assigned to the nearest centroid based on Euclidean distance. Centroids were then recalculated as the mean of all countries assigned to each cluster. The assignment and centroid recalculation steps were repeated iteratively until the cluster assignments stabilized. Using random initialization with seed ‘123’, we achieved a total within-cluster sum of squares (WSS) of 15.51587.

2.  Deterministic centroids: Initial centroids were taken from the hierarchical Ward solution. Countries were assigned to the nearest hierarchical centroids, and cluster centers were iteratively updated until convergence. This approach yielded a WSS of 15.60823.

The second approach, which combined Hierarchical and Non-Hierarchical methods, produced a stable solution and fully replicable, even if the total WSS is slightly higher than that of a random start. Using hierarchical centroids as initial seeds ensured that the k-means solution was robust, replicable, and consistent with the overall structure identified in the dendrogram. Moreover, the deterministic method is more interpretable, supporting the decision to choose this approach over random initialization despite the marginal difference in WSS. The final interpretation of the clusters is presented in the Results section.

## Results and Discussion

### Cluster Analysis

Before computing the Cluster Analysis, a preliminary inspection of the country-level distributions (figure X – boxplot) identified the Hungary (HU) as an outlier on the immigration dimension. Addressing potential data distortions is a critical step for a robust analysis, particularly when employing methods sensitive to extreme values, such as hierarchical or partition clustering (k-means).

The clustering procedures employed, the hierarchical clustering with Ward’s method followed by k-means refining, are known to be sensitive to outliers. Ward's method minimizes the total within-cluster variance, which can be easily influenced by single extreme points.

However, this deviation reflects a stable empirical pattern. Comparative studies show Hungary recording the most negative attitudes towards immigration within the European Union. For example, research like "Keep Europe for the Europeans’: The Role of Threat Perceptions and Intergroup Contact for Explaining Attitudes towards Immigrants in Hungary" strongly supports the characterization of Hungary's highly restrictive attitudinal profile. Therefore, as this profile represents a genuine and documented country-level structure, Hungary was retained in the dataset.

From the analysis of the box plot, it could be argued that there are extreme values in the support of gender equality and trust in public institutions factors that could impact the formation of the clusters. However, there are no countries with extreme values in all factors nor with values outside the limits of the box plot.

Nevertheless, the analysis demonstrated that the presence of Hungary did not distort the overall cluster solution. Instead of pulling neighboring clusters or merging with unrelated profiles, the atypical case of Hungary, along with Slovakia, formed a small but interpretable cluster (cluster 5). This outcome confirms that the extreme values of Hungary helped reveal a meaningful structural difference in the data rather than introducing a statistical artifact, thereby validating the decision for its retention.

#### Hierarchical Cluster Analysis

Multiple hierarchical clustering methods were computed and compared, as already mentioned in the previous chapter.

Ward's method was selected as the optimal approach due to its balance between strong clustering structure (Agglomerative Coefficient = 0.853) and practical interpretability. The resulting dendrogram (@fig-dendrogram) shows a clear hierarchical structure with five distinct clusters at the chosen cut height.

#### Non-hierarchical Cluster Analysis

Following the practice of combining the exploratory strengths of hierarchical techniques with the optimization advantages of partition-based algorithms, a k-means analysis was subsequently applied. We used the centroids derived from the hierarchical clustering (Ward’s method) as initial seeds. The results are very similar to the hierarchical and non-hierarchical ones. The k-means analysis only used one iteration to converge, meaning that the solution is stable.

The random k-means (25 starts, set.seed(123) for replicability) procedure also had been tested. Both procedures (hierarchical and non-hierarchical) produced broadly similar clustering patterns.\
Minor differences emerged between the two methods. Specifically, three countries, Ireland, Belgium, and Slovenia, were assigned to different clusters, an expected outcome given the sensitivity of k-means to initialization. Given its stronger conceptual consistency and homogeneous grouping structure, the k-means with deterministic initialization was the solution adopted as final.

#### Final Cluster Solution

The optimized k-means solution resulted in five clusters of sizes 9, 3, 5, 3, and 2 countries. @tbl-centroids presents the cluster’s centroids, which reflect the average standardized scores for trust in public institutions, the attitude towards immigration, and perceptions on gender equality within each group.

These centroids represent the defining attitudinal signatures of the respective clusters.

| **Cluster** | **Size** | **Trust** | **Immigration** | **Equality** | **Countries** |
|------------|------------|------------|------------|------------|------------|
| 1 | 9 | 0.0079 | 0.3879 | -0.3723 | Ireland (IE), Belgium (BE), Slovenia (SI), Austria (AT), Germany (DE), Estonia (EE), Lithuania (LT), Latvia (LV), Poland (PL) |
| 2 | 3 | -0.9594 | -1.2188 | -0.1952 | Bulgaria (BG), Cyprus (CY), Greece (GR) |
| 3 | 5 | -0.7199 | 0.3501 | 1.1542 | Spain (ES), France (FR), Croatia (HR), Italy (IT), Portugal (PT) |
| 4 | 3 | 1.7990 | 0.8450 | 0.5326 | Finland (FI), Netherlands (NL), Sweden (SE) |
| 5 | 2 | 0.5045 | -2.060 | -1.7160 | Hungary (HU), Slovakia (SK) |

: Cluster Centroids {#tbl-centroids}

The within-cluster sum of squares indicates relatively compact clusters, and the ratio of between-cluster to total sum of squares, 75.4%, demonstrates substantial separation among groups. These results confirm that the five-cluster configuration captures meaningful cross-national differences in trust in public institutions, the attitude towards immigration, and perceptions on gender equality.

Following standard practice for validating cluster solutions, a neighbouring four-cluster and six-cluster solutions were also tested. The four-cluster alternative proved inadequate, as it merged clusters 2 and 5. This was problematic because Hungary (HU) exhibited extreme values on attitude towards immigration factor and required isolation in a distinct cluster alongside Slovakia (SK). Forcing these outlier cases into a larger grouping would have concealed important country-specific patterns. The six-cluster solution fragmented the cluster one by isolating Lithuania and Latvia in a new cluster. This over-segmentation reduced interpretability without meaningful improvement in substantive understanding. The five-cluster solution was therefore retained as the most coherent and substantively informative model, with comparative results presented in the Appendix.

#### Cluster Interpretation and Visualization

The scatter plots in @fig-cluster-scatterplot illustrate the distribution of countries across the three dimensions, with cluster membership represented by color. The visualization seems to confirm the five-cluster solution, showing separation between groups with minimal overlap, although the visualization in 2D simplifies the complete three-dimensional structure.

```{r}
#| label: fig-cluster-scatterplot
#| fig-cap: Cluster Scatterplot

cluster_colors <- c(
  "1" = "#E69F00",
  "2" = "#0072B2",
  "3" = "#009E73",
  "4" = "#D55E00",
  "5" = "#CC79A7"
)

# Create pairs dataframe
pairs_df2 <- country_clusters_d %>%
  mutate(id = row_number()) %>%
  crossing(
    tibble(var1 = c("equality", "equality", "immigration"),
           var2 = c("immigration", "trust", "trust"))
  ) %>%
  mutate(
    value1 = case_when(
      var1 == "equality" ~ equality,
      var1 == "immigration" ~ immigration,
      var1 == "trust" ~ trust
    ),
    value2 = case_when(
      var2 == "equality" ~ equality,
      var2 == "immigration" ~ immigration,
      var2 == "trust" ~ trust
    )
  ) %>%
  select(id, country, cluster, var1, var2, value1, value2)

# Add pair column
pairs_df2 <- pairs_df2 %>%
  mutate(pair = paste(var1, "vs", var2))

# Create reference lines dataframe with dynamic intercepts
reference_lines2 <- tibble(
  pair = c("equality vs immigration", "equality vs trust", "immigration vs trust"),
  var1 = c("equality", "equality", "immigration"),
  var2 = c("immigration", "trust", "trust")
) %>%
  mutate(
    # Horizontal intercept (mean of var2)
    h_intercept = case_when(
      var2 == "immigration" ~ mean(country_clusters_d$immigration, na.rm = TRUE),
      var2 == "trust" ~ mean(country_clusters_d$trust, na.rm = TRUE),
      var2 == "equality" ~ mean(country_clusters_d$equality, na.rm = TRUE)
    ),
    # Vertical intercept (mean of var1)
    v_intercept = case_when(
      var1 == "immigration" ~ mean(country_clusters_d$immigration, na.rm = TRUE),
      var1 == "trust" ~ mean(country_clusters_d$trust, na.rm = TRUE),
      var1 == "equality" ~ mean(country_clusters_d$equality, na.rm = TRUE)
    )
  )

# Create the plot
facet_plot_2 <- ggplot(pairs_df2, aes(x = value1, y = value2, color = cluster)) +
  
  # Dynamic reference lines
  geom_hline(data = reference_lines2, aes(yintercept = h_intercept),
             linetype = "dashed", color = "gray50", alpha = 0.5) +
  geom_vline(data = reference_lines2, aes(xintercept = v_intercept),
             linetype = "dashed", color = "gray50", alpha = 0.5) +
  
  geom_point(size = 3, alpha = 0.7) +
  geom_text_repel(aes(label = country), size = 3.5, show.legend = FALSE) +
  
  # Facets
  facet_wrap(~ pair) +
  coord_equal() +
  
  scale_color_manual(values = cluster_colors) +
  
  labs(
   # title = "Country cluster profiles across three dimension model",
    x = NULL,
    y = NULL,
    color = "Cluster"
  ) +
  

  
  my_theme() +
  theme(
    legend.position = "right",
    panel.background = element_rect(fill = "grey95", color = NA),  # Light grey background
    panel.border = element_rect(color = "grey70", fill = NA, linewidth = 0.5)  # Optional: border around each panel
  )

print(facet_plot_2)
```

Cluster 1, with nine members, needs additional discussion given its relatively higher within-cluster variance (within ss per country = 0.86) and weaker silhouette coefficient (0.211) compared to other clusters. Although this weak pattern, this cluster reflects the nature of this group - countries with balanced, moderated profiles across all three dimensions. These nations do not exhibit extreme positions on institutional trust, immigration attitudes and gender equality perceptions, but rather occupy the “middle ground” of EU attitudes.

Countries with moderate scores cluster together precisely because they lack the distinctive extremes that characterize other groups. This result in a larger, more diffuse cluster, where members are similar with their moderation but inevitably show greater internal variation than clusters defined by the extreme values. The cluster remains valid as members are still more similar to each other than to any other cluster.

| **Country** | **Distance to own cluster** | **Nearest alternative** | **Distance to the nearest neighbor** |
|------------------|------------------|------------------|--------------------|
| AT - Austria | 0.981 | 2 | 1.775 |
| BE - Belgium | 0.956 | 3 | 1.202 |
| DE - Germany | 0.690 | 4 | 1.552 |
| EE - Estonia | 0.609 | 2 | 1.899 |
| IE - Ireland | 0.941 | 4 | 1.154 |
| LT - Lithuania | 1.047 | 2 | 2.283 |
| LV - Latvia | 1.376 | 2 | 1.8 |
| PL - Poland | 0.807 | 2 | 1.408 |
| SI - Slovenia | 0.717 | 3 | 1.075 |

: Cluster 1 Statistics {#tbl-cluster1}

#### Factor Analysis

The first factor is *trust in public institutions*, which derives from six variables that capture citizens’ trust in politicians, political parties, National and European Parliament, the legal system, and the United Nations.

The second factor captures *attitudes toward immigration* and comprises six variables measuring citizens’ openness to immigration and their evaluation of immigration’s contribution to the host country from economic, cultural, and quality-of-life perspectives. For analytical parsimony, we decided on three factors instead of four, which would have implied splitting this dimension into two separate constructs. Hence, this factor represents a net perspective on immigration, combining both openness and perceived contribution, even though these may lead to distinct conclusions.

The third and final latent dimension is the *perception on gender equality*, comprising four variables, it assesses the importance citizens attribute to gender equality in the domains of work, wages, corporate management, and political activity.

```{r}
#| label: fig-pairwise-graph
#| fig-cap: "Pairwise Country Comparisons Across Dimensions"
#faceting 1

pairs_df <- country_means2 %>%
  mutate(id = row_number()) %>%
  crossing(
    tibble(var1 = c("equality", "equality", "immigration"),
           var2 = c("immigration", "trust", "trust"))
  ) %>%
  mutate(
    value1 = case_when(
      var1 == "equality" ~ equality,
      var1 == "immigration" ~ immigration,
      var1 == "trust" ~ trust
    ),
    value2 = case_when(
      var2 == "equality" ~ equality,
      var2 == "immigration" ~ immigration,
      var2 == "trust" ~ trust
    )
  ) %>%
  select(id, country, var1, var2, value1, value2)

pairs_df <- pairs_df %>%
  mutate(pair = paste(var1, "vs", var2))

reference_lines <- tibble(
  pair = c("equality vs immigration", "equality vs trust", "immigration vs trust"),
  var1 = c("equality", "equality", "immigration"),
  var2 = c("immigration", "trust", "trust")
) %>%
  mutate(
    # Horizontal intercept (mean of var2)
    h_intercept = case_when(
      var2 == "immigration" ~ mean(country_means2$immigration, na.rm = TRUE),
      var2 == "trust" ~ mean(country_means2$trust, na.rm = TRUE),
      var2 == "equality" ~ mean(country_means2$equality, na.rm = TRUE)
    ),
    # Vertical intercept (mean of var1)
    v_intercept = case_when(
      var1 == "immigration" ~ mean(country_means2$immigration, na.rm = TRUE),
      var1 == "trust" ~ mean(country_means2$trust, na.rm = TRUE),
      var1 == "equality" ~ mean(country_means2$equality, na.rm = TRUE)
    )
  )

facet_plot <- ggplot(pairs_df, aes(x = value1, y = value2, color = pair)) +
  
  geom_hline(data = reference_lines, aes(yintercept = h_intercept),
             linetype = "dashed", color = "gray50", alpha = 0.5) +
  geom_vline(data = reference_lines, aes(xintercept = v_intercept),
             linetype = "dashed", color = "gray50", alpha = 0.5) +
  geom_point(size = 3, alpha = 0.7) +
  geom_text_repel(aes(label = country), size = 3.5, show.legend = FALSE) +
  facet_wrap(~ pair) +
  coord_equal() +
  scale_color_manual(values = c(  # Add 'values ='
    "equality vs immigration" = "#E69F00",
    "equality vs trust" = "#009E73",
    "immigration vs trust" = "#0072B2"
  ))+
  
  labs(
   # title = "Pairwise Country Comparisons Across Dimensions",
    x = NULL,
    y = NULL
  ) +
  
  my_theme() +
  theme(legend.position = "none")

print(facet_plot)
```

@fig-pairwise-graph presents a comparison of mean factor scores across countries. The first quadrant (upper right) contains the countries scoring above the sample average on the respective indicators, whereas the third quadrant (lower left) comprises those scoring below the average. Sweden, Finland, the Netherlands, Belgium, and Ireland display positive scores across all three factors. In contrast, Greece is the only country exhibiting negative scores on all factors. Examining the factors individually, Sweden, Finland, and the Netherlands record the highest levels of trust in public institutions (scores above 1), while Croatia and Bulgaria record the lowest (scores below 1). Regarding attitudes toward immigration, Sweden, Estonia, and Germany rank highest, whereas Hungary, Cyprus and Slovakia rank lowest. Finally, in terms of the importance attributed to gender equality, Portugal, Spain, and France score highest, while Slovakia, Lithuania, and Latvia score lowest.

#### Cluster Analysis

The Cluster Analysis identified five groups of countries that exhibit internal similarity with respect to the factor-derived dimensions.

| **Cluster** | **Trust**      | **Immigration** | **Gender Equality** |
|-------------|----------------|-----------------|---------------------|
| 1           | Moderate       | Mostly High (+) | Moderate            |
| 2           | Low (-)        | Low (-)         | Low (-) / High (+)  |
| 3           | Low (-)        | Mostly High (+) | High (+)            |
| 4           | Very High (++) | High (+)        | High (+)            |
| 5           | High (+)       | Very Low (--)   | Very Low (--)       |

: Cluster Summary {#tbl-cluster-summary}

Given the three-dimensional structure, a summary table was also produced, examining the scores of the countries included in each cluster to facilitate the interpretation. Cluster 1 is the largest group (nine countries) and presents scores close to the overall mean, both positive and negative, regarding institutional trust and attitudes to gender equality. These countries are therefore characterised as *moderate countries*. Countries in Cluster 2 are defined by low levels of institutional trust and negative attitudes towards immigration and are consequently labelled *distrustful of institutions and closed to immigration*. Cluster 3 contains countries that are *distrustful of institutions yet open to immigration and supportive of gender equality*. Cluster 4 includes the countries that stand out as most positively across all dimensions. They exhibit *high trust in institutions, openness to immigration, and support for gender equality*. Finally, Cluster 5 consists of countries characterized by high institutional trust but negative attitudes towards immigration and a lower valuation of gender equality, hence described as *trusting institutions but closed to immigration and not prioritizing gender equality*.

#### Geographical Patterns of the Clusters

The geographical distribution of the clusters reveals clear spatial patterns (Figure X). The “moderate countries” are located predominantly in Central Europe and around the Baltic Sea, with Ireland as an exception. Countries most “distrustful of institutions and closed to immigration” are concentrated in South-eastern Europe (Bulgaria, Greece, and Cyprus). Countries “distrustful of institutions but open to immigration and supportive of gender equality” are mainly located in South-western Europe (Portugal, Spain, France, and Italy), except for Croatia. Countries with “higher trust in institutions, openness to immigration, and support for gender equality” are concentrated in Northern Europe, except for the Netherlands. Finally, the cluster of countries that “trust institutions but are closed to immigration and do not value gender equality” comprises Hungary and Slovakia, neighboring Central European states.

These results may reflect the profile of national political leadership, which shares notable personal and ideological affinities across countries. Overall, these patters suggest that geographical proximity, as well as historical and political linkages, may contribute to shared value orientations and behavioral tendencies in the analysed domains.

```{r}
# colnames(pcf_varimax$loadings) <- c("Trust","Immigration", "Equality")
# fa.diagram(pcf_varimax)

```

```{r}
#| eval: false
#| include: false
loadings_df <- as.data.frame(pcf_varimax$loadings[,])
loadings_df$variable <- rownames(loadings_df)

# Reshape to long format
loadings_long <- pivot_longer(loadings_df, 
                              cols = -variable, 
                              names_to = "Component", 
                              values_to = "Loading")

# Create a better visualization
ggplot(loadings_long, aes(x = Component, y = variable, fill = Loading)) +
  geom_tile() +
  geom_text(aes(label = round(Loading, 2)), size = 3) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", 
                       midpoint = 0) +
  theme_minimal() +
  labs(title = "Component Loadings Heatmap",
       x = "Components", y = "Variables")
```

```{r}
#Compare methods random vs deterministic
# Compare cluster assignments
comparison <- data.frame(
  country = rownames(cluster_data),
  hierarchical_kmeans = kmeans_result_d$cluster,
  random_kmeans = kmeans_result$cluster
) %>% 
  arrange(hierarchical_kmeans, random_kmeans)

# Check agreement
#print(comparison)
#write_csv(comparison, "C:/Users/ricardo.branco/Downloads/comparison.csv")

# Within-cluster sum of squares (lower is better)
#cat("Deterministic total WSS:", kmeans_result_d$tot.withinss, "\n")
#cat("Random total WSS:", kmeans_result$tot.withinss, "\n")


```

```{r}
#Prepare data for visualization
#1.color uniformity
cluster_colors <- c(
  "1" = "#E69F00",
  "2" = "#0072B2",
  "3" = "#009E73",
  "4" = "#D55E00",
  "5" = "#CC79A7"
)

```

```{r}
#faceting 2

pairs_df2 <- country_clusters_d %>%
  mutate(id = row_number()) %>%
  crossing(
    tibble(var1 = c("equality", "equality", "immigration"),
           var2 = c("immigration", "trust", "trust"))
  ) %>%
  mutate(
    value1 = case_when(
      var1 == "equality" ~ equality,
      var1 == "immigration" ~ immigration,
      var1 == "trust" ~ trust
    ),
    value2 = case_when(
      var2 == "equality" ~ equality,
      var2 == "immigration" ~ immigration,
      var2 == "trust" ~ trust
    )
  ) %>%
  select(id, country, cluster, var1, var2, value1, value2)

facet_plot_2 <- ggplot(pairs_df2, 
                     aes(x = value1, y = value2, color = cluster)) +
  
  geom_hline(yintercept = mean(country_means2$trust),
             linetype = "dashed", color = "gray50", alpha = 0.5) +
  geom_vline(xintercept = mean(country_means2$equality),
             linetype = "dashed", color = "gray50", alpha = 0.5) +

  geom_point(size = 3, alpha = 0.7) +
  geom_text_repel(aes(label = country, color = cluster), size = 3) +

  facet_wrap(~ paste(var1, "vs", var2)) +
  coord_equal()+
  scale_color_manual(values = cluster_colors) +
  
  labs(
    title = "Pairwise Country Comparisons Across Dimensions",
    x = NULL,
    y = NULL,
    color = "Cluster"
  ) +
  
  my_theme()


```

```{r}
# Define Lookup and Cluster Data ---

# Revised lookup table with all 22 countries
country_lookup <- data.frame(
  country = c("AT", "BE", "BG", "CY", "DE", "EE", "ES", "FI", "FR", "GR", "HR", "HU", "IE", "IT", "LT", "LV", "NL", "PL", "PT", "SE", "SI", "SK"),
  map_region = c("Austria", "Belgium", "Bulgaria", "Cyprus", "Germany", "Estonia", "Spain", "Finland", "France", "Greece", "Croatia", "Hungary", "Ireland", "Italy", "Lithuania", "Latvia", "Netherlands", "Poland", "Portugal", "Sweden", "Slovenia", "Slovakia")
)

# Data Merging and Preparation ---
# Get Europe map data
europe_map <- map_data("world")

# Merge your data with the lookup
country_clusters_full <- merge(country_clusters_d, country_lookup, by = "country")

# Merge with map data
europe_map <- merge(europe_map, country_clusters_full, by.x = "region", by.y = "map_region", all.x = TRUE)

# Filter to only show countries in your dataset
europe_map <- europe_map %>% filter(region %in% country_lookup$map_region)

europe_map <- europe_map %>%
  dplyr::arrange(group, order, long)

# Create the Map ---

ggplot(europe_map, aes(x = long, y = lat, group = group, fill = cluster)) +
  geom_polygon(color = "white", linewidth = 0.25) +
  scale_fill_manual(values = cluster_colors, name = "Clusters", na.value = "lightgray") +
  # Adjusted limits to better frame the entire region
  coord_fixed(1.3, xlim = c(-15, 35), ylim = c(32, 72)) +
  theme_void() +
  labs(title = "European Countries by Cluster", subtitle = "Based on trust, immigration, and equality attitudes") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", margin = margin(b = 5)),
    plot.subtitle = element_text(hjust = 0.5, size = 11, margin = margin(b = 15)),
    legend.position = "bottom",
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9)
  )
```

```{r}
#| eval: false
#| include: false


# STARTS HERE the CORRESPONDENCE ANALYSIS
pt_df_ca <- raw_data %>%
  filter(cntry == "PT") %>%
  filter(icgndra %in% c(1, 2)) %>%
  filter(agea <= 99) %>% 
  filter(
    # Trust variables (0-10 scale)
    trstprl %in% 0:10, trstlgl %in% 0:10, trstplt %in% 0:10, 
    trstprt %in% 0:10, trstep %in% 0:10, trstun %in% 0:10,
    # Immigration variables (0-10 scale)
    imbgeco %in% 0:10, imueclt %in% 0:10, imwbcnt %in% 0:10,
    # Immigration variables (1-4 scale)
    imsmetn %in% 1:4, imdfetn %in% 1:4, impcntr %in% 1:4,
    # Equality variables (depends on their scale)
    eqwrkbg %in% 1:6, eqpolbg %in% 1:6, eqmgmbg %in% 1:6, eqpaybg %in% 1:6  # selecting only obs values
  ) %>% 
  mutate(icgndra = factor(icgndra, levels = c(1, 2), labels = c("Male", "Female"))) %>%
  select(
    #country
    cntry,
    #Gender
    icgndra,
    # Age variable
    agea,
    # Trust variables
    trstprl, trstlgl, trstplt, trstprt, trstep, trstun,
    # Immigration variables
    imbgeco, imueclt, imwbcnt, imsmetn, imdfetn, impcntr,
    # Equality variables
    eqwrkbg, eqpolbg, eqmgmbg, eqpaybg
  ) %>%
    na.omit() |> # omit missing values
    mutate(imsmetn = 5 - imsmetn, 
         imdfetn = 5 - imdfetn,
         impcntr = 5 - impcntr
        ) # invert scale of some variables


hist(pt_df_ca$agea, main = "Age Distribution in Portugal plus France", 
     xlab = "Age", col = "#0072B2", breaks = 10)




```

```{r}
#| eval: false
#| include: false
pt_df_ca <- pt_df_ca %>%
  mutate(
    age_group = case_when(
      agea < 30 ~ "15-29",
      agea >= 30 & agea < 45 ~ "30-44",
      agea >= 45 & agea < 60 ~ "45-59",
      agea >= 60 ~ "60+"
    ),
    age_group = factor(age_group, levels = c("18-29", "30-44", "45-59", "60+"))
  )

# Check distribution
table(pt_df_ca$age_group)
```

```{r}

# # Extract loadings matrix
# loadings_matrix <- pcf_varimax$loadings[, c("RC1", "RC2", "RC3")]
# 
# # Create loadings vectors, keeping only values > 0.5, rest = 0
# rc1 <- ifelse(abs(loadings_matrix[, "RC1"]) > 0.5, loadings_matrix[, "RC1"], 0)
# rc2 <- ifelse(abs(loadings_matrix[, "RC2"]) > 0.5, loadings_matrix[, "RC2"], 0)
# rc3 <- ifelse(abs(loadings_matrix[, "RC3"]) > 0.5, loadings_matrix[, "RC3"], 0)
# 
# # Show which variables are used for each factor
# data.frame(
#   variable = rownames(loadings_matrix),
#   RC1_immigration = rc1,
#   RC2_trust = rc2,
#   RC3_equality = rc3)
# 
# # Now compute weighted indices
# fa_vars <- pt_df_ca[, rownames(loadings_matrix)]
# fa_vars <- as.matrix(sapply(fa_vars, as.numeric))
# 
# pt_df_ca <- pt_df_ca %>%
#   mutate(
#     immigration = fa_vars %*% rc1,
#     trust = fa_vars %*% rc2,
#     equality = fa_vars %*% rc3
#   )
# 
# 
# pt_df_ca <- pt_df_ca %>%
#   mutate(
#     trust_cat = cut(trust,
#                     breaks = unique(quantile(trust, probs = c(0, .25, .50, .75, 1), na.rm = TRUE)),
#                     include.lowest = TRUE,
#                     labels = c("Very Weak", "Weak", "Strong", "Very Strong")[1:(length(unique(quantile(trust, probs = c(0, .25, .50, .75, 1), na.rm = TRUE)))-1)]),
#     
#     immigration_cat = cut(immigration,
#                           breaks = unique(quantile(immigration, probs = c(0, .25, .50, .75, 1), na.rm = TRUE)),
#                           include.lowest = TRUE,
#                           labels = c("Very Weak", "Weak", "Strong", "Very Strong")[1:(length(unique(quantile(immigration, probs = c(0, .25, .50, .75, 1), na.rm = TRUE)))-1)]),
#     
#     equality_cat = cut(equality,
#                        breaks = unique(quantile(equality, probs = c(0, .25, .50, .75, 1), na.rm = TRUE)),
#                        include.lowest = TRUE,
#                        labels = c("Very Weak", "Weak", "Strong", "Very Strong")[1:(length(unique(quantile(equality, probs = c(0, .25, .50, .75, 1), na.rm = TRUE)))-1)]),
#     
#     age_group = paste(age_group, " (", cntry, ", ", icgndra, ")")
#   )
```

```{r}
# tab <- table(pt_df_ca$age_group, pt_df_ca$trust_cat)
# 
# ca_result <- CA(tab, graph = FALSE)
# 
# # Scree plot
# fviz_screeplot(ca_result)
# 
# # Biplot with labels
# fviz_ca_biplot(ca_result, repel = TRUE)
# 
# # Row factor map
# fviz_ca_row(ca_result, repel = TRUE)
# 
# # Column factor map
# fviz_ca_col(ca_result, repel = TRUE)
```

```{r}

# # Your contingency table
# tab <- table(pt_df_ca$age_group, pt_df_ca$immigration_cat)
# 
# # Perform Correspondence Analysis
# ca_result <- CA(tab, graph = FALSE)
# 
# # Observed values
# observed <- tab
# 
# # Expected values under independence
# expected <- chisq.test(tab)$expected
# 
# # Combine observed and expected in a single data frame for comparison
# comparison_df <- data.frame(
#   Row = rep(rownames(observed), times = ncol(observed)),
#   Column = rep(colnames(observed), each = nrow(observed)),
#   Observed = as.vector(observed),
#   Expected = as.vector(expected) 
# )
# 
# comparison_df <- comparison_df %>% 
#     mutate(Diff = comparison_df$Observed - comparison_df$Expected ) %>% 
#     arrange(Diff) %>% 
#     print(n = 10)
# 
# # Create a heatmap of the difference
# ggplot(comparison_df, aes(x = Column, y = Row, fill = Diff)) +
#   geom_tile(color = "white") +
#   scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
#   geom_text(aes(label = Observed), color = "black") +
#   theme_minimal() +
#   labs(title = "Observed vs Expected (Difference) Heatmap",
#        fill = "Observed - Expected")
```

### Limitations and Problems Faced

The main limitation of Factor Analysis and Cluster Analysis is that they are highly subjective and dependent on the set of observations. We tried different question combinations and chose the one that provided the best, most interpretable results. It could, however, be that if we had chosen different questions, even if for the same issued, we would have obtained different factors and results.

The same logic can be applied with the countries selected. The database used does not cover the entire set of European Union Member States, as this round of the survey was not conducted in five countries – Czechia, Denmark, Luxembourg, Malta, and Romania. Additionally, the survey lacks a question on trust in the government (i.e., the executive branch of the state), preventing a fully comprehensive assessment of trust in the key pillars of democratic governance.

An opportunity for further enrichment lies in the reproduction of this project using previous rounds of the European Social Survey, which would allow for an examination of temporal evolution of factor scores and cluster membership.

## Conclusion

In this project, we aimed at examining how European citizens perceive three central and highly debated subjects – immigration, gender equality, and trust in public institutions – using data from Round 11 of the European Social Survey. By combining Factor Analysis and Cluster Analysis, we sought to extract and interpret both the latent attitudinal structures underlying individual responses and the broader country-level patterns that emerge across the European Union.

From the Factor Analysis, we were able to identify three coherent and theoretically meaningful factors corresponding to the subjects mentioned beforehand: trust in public institutions, attitudes toward immigration, and perceptions on gender equality. The results underlined the complex public opinion of European citizens on these matters, as factor scores vary considerably across country in each topic. Additionally, we can conclude that higher trust in public institutions does not necessarily translate into more favourable attitudes towards immigration and gender equality.

Utilizing these latent dimensions, the Cluster Analysis identified five distinct country clusters with clear internal coherence and interpretability. These clusters reflect different degrees of trust in public institutions, attitudes towards immigration, and perceptions on gender equality, but also meaningful geographical and political patterns across the EU.

Northern European countries are notable for their consistent trust in public institutions, receptiveness to immigration, and endorsement of gender equality. Countries in the Southern and South-eastern Europe often exhibit less trust in public institutions alongside more polarized opinions on immigration and equality. Central and Eastern European countries display more diverse profiles, including a distinct cluster characterized by high institutional trust but restrictive attitudes toward immigration and gender equality.

Henceforth, the findings imply that institutional trust serves as a key axis of distinction among European societies, yet it does not consistently lead to progressive views on immigration or gender equality. This divergence carries significant consequences for EU policy making, indicating the limitations of universal approaches.

Although it offers valuable insights, the research has its shortcomings, namely, the partial European country coverage of ESS Round 11 and the absence of a direct question of trust in national governments. Moreover, the inherently subjective nature of Factor and Cluster Analysis means that alternative variable selections could yield different results.

To sum up, this study helps us understand the social basis on which European integration evolves by uncovering both common trends and persistent divides in citizens’ perspectives on immigration, gender equality, and trust in public institutions. Further studies applying this method across various ESS rounds would be especially useful for evaluating how these perspectives evolve over time and in reaction to significant political, economic, and social upheavals.

## Appendix

```{=latex}
\begin{tabular}{p{0.1\textwidth} p{0.6\textwidth} p{0.3\textwidth}} \toprule
\caption{Variable Descriptions and Measurement Scales}
\label{tbl-vars}

\textbf{ID} & \textbf{Question} & \textbf{Scale} \\ \midrule
trstprl & How much do you personally trust [country]'s parliament? & 0 (No trust at all) - 10 (Complete trust) \\ \midrule
trstlgl & How much do you personally trust the legal system? & 0 (No trust at all) - 10 (Complete trust) \\ \midrule
trstplt & How much do you personally trust politicians? & 0 (No trust at all) - 10 (Complete trust) \\ \midrule
trstprt & How much do you personally trust political parties? & 0 (No trust at all) - 10 (Complete trust) \\ \midrule
trstep & How much do you personally trust the European Parliament? & 0 (No trust at all) - 10 (Complete trust) \\ \midrule
trstun & How much do you personally trust the United Nations? & 0 (No trust at all) - 10 (Complete trust) \\ \midrule
imbgeco & Would you say it is generally bad or good for [country]'s economy that people come to live here from other countries? & 0 (Bad for economy) - 10 (Good for economy) \\ \midrule
imueclt & Would you say that [country]'s cultural life is generally undermined or enriched by people coming to live here from other countries? & 0 (Cultural life undermined) - 10 (Cultural life enriched) \\ \midrule
imwbcnt & Is [country] made a worse or a better place to live by people coming to live here from other countries? & 0 (Worse place to live) - 10 (Better place to live) \\ \midrule
imsmetn$^{*}$ & To what extent do you think [country] should allow people of the same race or ethnic group as most [country]'s people to come and live here? & 1 (Allow many) - 4 (Allow none) \\ \midrule
imdfetn$^{*}$ & To what extent do you think [country] should allow people of a different race or ethnic group from most [country] people to come and live here? & 1 (Allow many) - 4 (Allow none) \\ \midrule
impcntr$^{*}$ & To what extent do you think [country] should allow people from poorer countries outside Europe to come and live here? & 1 (Allow many) - 4 (Allow none) \\ \midrule
eqwrkbg & In general, how bad or good is it for family life in [country] if equal numbers of women and men are in paid work? & 0 (Very bad) - 6 (Very good) \\ \midrule
eqpolbg & In general, how bad or good is it for politics in [country] if equal numbers of women and men are in positions of political leadership? & 0 (Very bad) - 6 (Very good) \\ \midrule
eqmgmbg & In general, how bad or good is it for businesses in [country] if equal numbers of women and men are in higher management positions? & 0 (Very bad) - 6 (Very good) \\ \midrule
eqpaybg & In general, how bad or good is it for the strength of the economy in [country] if women and men receive equal pay for doing the same work? & 0 (Very bad) - 6 (Very good) \\ \midrule
\bottomrule
\end{tabular}
``` 


^\*^ The original scales of these three variables were reversed so that higher values consistently represent more positive or more permissive attitudes across all questions

|     Country      | Number of observations |
|:----------------:|:----------------------:|
|   AT - Austria   |          1716          |
|   BE - Belgium   |          1360          |
|  BG - Bulgaria   |          1554          |
|   CY - Cyprus    |          516           |
|   DE - Germany   |          2046          |
|   EE - Estonia   |          891           |
|    ES - Spain    |          1448          |
|   FI - Finland   |          1372          |
|   FR - France    |          1382          |
|   GR - Greece    |          2174          |
|   HR - Croatia   |          1200          |
|   HU - Hungary   |          1473          |
|   IE - Ireland   |          1360          |
|    IT - Italy    |          2165          |
|  LT - Lithuania  |          904           |
|   LV - Latvia    |          612           |
| NL - Netherlands |          1312          |
|   PL - Poland    |          902           |
|  PT - Portugal   |          1036          |
|   SE - Sweden    |          1000          |
|  SI - Slovenia   |          897           |
|  SK - Slovakia   |          983           |

: Number of observations for each country {#tbl-obs}

```{r}
# # 1. Prepare data (select only numeric variables for clustering)
# cluster_data <- country_means2[, c("trust", "immigration", "equality")]
# rownames(cluster_data) <- country_means2$country
# 
# # 2. Hierarchical methods to determine number of clusters
# 
# # Ward method
# hc_ward <- agnes(cluster_data, metric = "euclidean", method = "ward")
# 
# # Average method
# hc_average <- agnes(cluster_data, metric = "euclidean", method = "average")
# 
# # Complete method
# hc_complete <- agnes(cluster_data, metric = "euclidean", method = "complete")
# 
# # Single method
# hc_single <- agnes(cluster_data, metric = "euclidean", method = "single")
# 
# 
# print(hc_ward$ac)
# print(hc_average$ac)
# print(hc_complete$ac)
# print(hc_single$ac)
# 
# 
# pltree(hc_ward, main = "Dendrogram - Ward Method", hang = -1, cex = 0.8)
# rect.hclust(hc_ward, k = 5, border = "red")
# 
# pltree(hc_ward, main = "Dendrogram - Ward Method", hang = -1, cex = 0.8)
# rect.hclust(hc_ward, k = 4, border = "red")
# 
# fviz_nbclust(cluster_data, kmeans, method = "wss")
# 
# fviz_nbclust(cluster_data, kmeans, method = "silhouette")
```

```{r}
# #Random k-means
# set.seed(123) #for replicability
# 
# kmeans_result_4 <- kmeans(cluster_data, centers = 4, nstart = 25, iter.max = 100) # nstart = different initial positions; 
# 
# print(kmeans_result_4)
# 
# country_clusters_4 <- country_means2
# country_clusters$cluster <- as.factor(kmeans_result_4$cluster)
# 
# ```
# 
# ```{r}
# #deterministic k-means using hierarchical method
# hcward4 <- agnes(cluster_data, method = "ward")
# 
# groups_hcward4 <- cutree(as.hclust(hcward4), k = 4) #cut the tree into 5 clusters (k)
# 
# initial_centers4 <- aggregate(cluster_data, by = list(groups_hcward4), FUN = mean) #compute deterministic initial centroids
# 
# initial_centers4 <- initial_centers4[ ,-1] # remove group label column
# 
# #compute k-means
# kmeans_result_d4 <- kmeans(cluster_data, centers = initial_centers4, iter.max = 100)
# 
# #merge to data
# country_clusters_d4 <- country_means2
# country_clusters_d4$cluster <- as.factor(kmeans_result_d4$cluster)
# 
# print(kmeans_result_d4$centers)
# print(table(country_clusters_d4$cluster))
```

```{r}
# #Compare methods random vs deterministic
# # Compare cluster assignments
# comparison4 <- data.frame(
#   country = rownames(cluster_data),
#   hierarchical_kmeans4 = kmeans_result_d4$cluster,
#   random_kmeans4 = kmeans_result_4$cluster
# ) %>% 
#   arrange(hierarchical_kmeans4, random_kmeans4)
# 
# # Check agreement
# print(comparison4)
# write_csv(comparison4, "C:/Users/ricardo.branco/Downloads/comparison4.csv")
# 
# # Within-cluster sum of squares (lower is better)
# cat("Deterministic total WSS:", kmeans_result_d4$tot.withinss, "\n")
# cat("Random total WSS:", kmeans_result4$tot.withinss, "\n")
# ```
# 
# ```{r}
# #Prepare data for visualization
# #1.color uniformity
# cluster_colors4 <- c(
#   "1" = "#E69F00",
#   "2" = "#0072B2",
#   "3" = "#009E73",
#   "4" = "#D55E00"
# )
```

```{r}
# #faceting 2
# 
# pairs_df2_4 <- country_clusters_d4 %>%
#   mutate(id = row_number()) %>%
#   crossing(
#     tibble(var1 = c("equality", "equality", "immigration"),
#            var2 = c("immigration", "trust", "trust"))
#   ) %>%
#   mutate(
#     value1 = case_when(
#       var1 == "equality" ~ equality,
#       var1 == "immigration" ~ immigration,
#       var1 == "trust" ~ trust
#     ),
#     value2 = case_when(
#       var2 == "equality" ~ equality,
#       var2 == "immigration" ~ immigration,
#       var2 == "trust" ~ trust
#     )
#   ) %>%
#   select(id, country, cluster, var1, var2, value1, value2)
# 
# 
# facet_plot_2_4 <- ggplot(pairs_df2_4, 
#                      aes(x = value1, y = value2, color = cluster)) +
#   
#   geom_hline(yintercept = mean(country_means$trust),
#              linetype = "dashed", color = "gray50", alpha = 0.5) +
#   geom_vline(xintercept = mean(country_means$equality),
#              linetype = "dashed", color = "gray50", alpha = 0.5) +
# 
#   geom_point(size = 3, alpha = 0.7) +
#   geom_text_repel(aes(label = country, color = cluster), size = 3) +
# 
#   facet_wrap(~ paste(var1, "vs", var2)) +
#   coord_equal()+
#   scale_color_manual(values = cluster_colors) +
#   
#   labs(
#     title = "Pairwise Country Comparisons Across Dimensions",
#     x = NULL,
#     y = NULL,
#     color = "Cluster"
#   ) +
#   
#   my_theme()
# 
# print(facet_plot_2_4)
```

```{r}
# # Define Lookup and Cluster Data ---
# 
# # Revised lookup table with all 22 countries
# country_lookup <- data.frame(
#   country = c("AT", "BE", "BG", "CY", "DE", "EE", "ES", "FI", "FR", "GR", "HR", "HU", "IE", "IT", "LT", "LV", "NL", "PL", "PT", "SE", "SI", "SK"),
#   map_region = c("Austria", "Belgium", "Bulgaria", "Cyprus", "Germany", "Estonia", "Spain", "Finland", "France", "Greece", "Croatia", "Hungary", "Ireland", "Italy", "Lithuania", "Latvia", "Netherlands", "Poland", "Portugal", "Sweden", "Slovenia", "Slovakia")
# )
# 
# # Data Merging and Preparation ---
# # Get Europe map data
# europe_map <- map_data("world")
# 
# # Merge your data with the lookup
# country_clusters_full4 <- merge(country_clusters_d4, country_lookup, by = "country")
# 
# # Merge with map data
# europe_map <- merge(europe_map, country_clusters_full4, by.x = "region", by.y = "map_region", all.x = TRUE)
# 
# # Filter to only show countries in your dataset
# europe_map <- europe_map %>% filter(region %in% country_lookup$map_region)
# 
# europe_map <- europe_map %>%
#   dplyr::arrange(group, order, long)
# 
# # Create the Map ---
# country_centroids <- europe_map %>%
#   group_by(region) %>%
#   summarise(
#     long = mean(long),
#     lat = mean(lat),
#     cluster = first(cluster)
#   )
# 
# # Plot with labels
# ggplot(europe_map, aes(x = long, y = lat, group = group, fill = cluster)) +
#   geom_polygon(color = "white", linewidth = 0.25) +
#   geom_text(data = country_centroids, 
#             aes(x = long, y = lat, label = region, group = NULL),
#             size = 2.5, fontface = "bold", color = "black") +
#   scale_fill_manual(values = cluster_colors, name = "Clusters", na.value = "lightgray") +
#   coord_fixed(1.3, xlim = c(-15, 35), ylim = c(32, 72)) +
#   theme_void() +
#   labs(title = "European Countries by Cluster", 
#        subtitle = "Based on trust, immigration, and equality attitudes") +
#   theme(
#     plot.title = element_text(hjust = 0.5, size = 16, face = "bold", margin = margin(b = 5)),
#     plot.subtitle = element_text(hjust = 0.5, size = 11, margin = margin(b = 15)),
#     legend.position = "bottom",
#     legend.title = element_text(size = 10, face = "bold"),
#     legend.text = element_text(size = 9)
#   )
```
